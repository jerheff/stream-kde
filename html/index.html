<!DOCTYPE html>
<html style="width: 95%; height: 95%">
<head>
	<title>KDE of Seattle 911 call stream, sped up 20,000 times</title>
	<meta charset="utf-8" />

	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5.1/leaflet.css" />
	<!--[if lte IE 8]>
	    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5.1/leaflet.ie.css" />
	<![endif]-->

	<script src="http://cdn.leafletjs.com/leaflet-0.5.1/leaflet.js"></script>
</head>
<body style="width: 100%; height: 100%">
	<div id="map" style="width: 100%; height: 100%"></div>

	<script>
		var map = L.map('map').setView([47.60801, -122.33139], 12);
	//	var map = L.map('map', {maxZoom: 14}).setView([47.60801, -122.33139], 13);
    //L.tileLayer('http://{s}.tiles.mapbox.com/v3/mapbox.world-light/{z}/{x}/{y}.png', { maxZoom: 18 }).addTo(map)
    //L.tileLayer('http://{s}.tile.stamen.com/toner/{z}/{x}/{y}.png').addTo(map)
    L.tileLayer('http://{s}.tile.stamen.com/terrain/{z}/{x}/{y}.png',
                {attribution: 'Map data &copy;2013 OpenStreetMap contributors, Tiles &copy;2013 Stamen Design'}
               ).addTo(map);
		//var kdeURL = 'http://192.168.16.41:8888/kde', 
		var kdeURL = 'http://tr01.azavea.com/stream-kde/current.png'
		kdeBounds = [[47.43884, -122.4404], [47.78403, -122.2068]]
		
		var kde = new L.ImageOverlay(kdeURL, kdeBounds);
    var oldKde = null;

		map.addLayer(kde)

    var opacity = 1.0
    var newKdeOpacity = 0;
    var oldKdeOpacity = 0;

		kde.setOpacity(opacity)
		
		// Refresh image layer
		setInterval(function() {
      if (oldKde != null) {
        map.removeLayer(oldKde);
      }
      oldKde = kde;
      oldKdeOpacity = newKdeOpacity;

			var newKde = new L.ImageOverlay(kdeURL, kdeBounds);
			map.addLayer(newKde);
			newKde.setOpacity(0.1);
      newKdeOpacity = 0.1;      
      kde = newKde;
		}, 1 * 1750);


    // fade in, fade out
    setInterval(function() {
      if (oldKdeOpacity > 0) {
        if (oldKde != null) {
          oldKdeOpacity = oldKdeOpacity - 0.1;
          oldKde.setOpacity( oldKdeOpacity );
        }
      }
      if (newKdeOpacity < 1) {
        newKdeOpacity = newKdeOpacity + 0.1;
        kde.setOpacity( newKdeOpacity );
      }
    }, 50);

		var popup = L.popup();

		function onMapClick(e) {
			popup
				.setLatLng(e.latlng)
				.setContent("You clicked the map at " + e.latlng.toString())
				.openOn(map);
		}

		map.on('click', onMapClick);

	</script>
</body>
</html>
